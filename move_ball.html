<html>
<head>
	<title>move ball</title>
	<meta charset="utf-8">
	<style>
        canvas {
            border: 1px solid #000;
        }
    </style>
    <script>
        // <Todo>
        // ■PlayerAreaの作成
        // ■PlayerBallの動作ロジック作成
        // □Goal判定の追加
        // □EnemyAreaの作成
        // □EnemyBallの動作ロジック作成
        // □Ballの衝突判定/GameOver判定の追加
        // □Start画面作成
        // □色/アイコン調整
        // □各種変数化


        var canvas , context, x, timer, blocks=[], blockMap =[], blockWidth, blockHeight, startBlock = [];
        var player_x, player_y, player_direction, player;

        function init() {
            blockWidth = 100;
            blockHeight = 100;
            movable = 0;

            window.addEventListener("keydown", function(e) {
                chgMovable();
            }, true);

            window.addEventListener("touchstart", function(e) {
                chgMovable();
            }, true);

            window.addEventListener("keydown", function(e) {
                if (event.shiftKey) {
                    location.reload();
                }
            }, true);

            // Canvas要素の取得
            canvas = document.getElementById("myCanvas");
            context = canvas.getContext("2d");
           
            // ブロックパターン(name,left,up,right,down,center,type)
            blocks=[
                ["none"      , false, false, false, false, false, "none" ], // 0
                ["startLeft" , true , false, false, false, true , "start"], // 1
                ["startUp"   , false, true , false, false, true , "start"], // 2
                ["startRight", false, false, true , false, true , "start"], // 3
                ["startDown ", false, false, false, true , true , "start"], // 4
                ["goalLeft"  , true , false, false, false, true , "goal" ], // 5
                ["goalUp"    , false, true , false, false, true , "goal" ], // 6
                ["goalRight" , false, false, true , false, true , "goal" ], // 7
                ["goalDown " , false, false, false, true , true , "goal" ], // 8
                ["leftRight" , true , false, true , false, false, "none" ], // 9
                ["upDown"    , false, true , false, true , false, "none" ], // 10
                ["leftUp"    , true , true , false, false, false, "none" ], // 11
                ["upRight"   , false, true , true , false, false, "none" ], // 12
                ["rightDown" , false, false, true , true , false, "none" ], // 13
                ["downLeft"  , true , false, false, true , false, "none" ]  // 14
            ]

            blockMap=[
                [3,9,9,14],
                [13,9,9,11],
                [12,9,9,5]
            ]

            startBlock = getStartBlock();
            player_x = startBlock[1]*blockWidth + (blockWidth/2);
            player_y = startBlock[0]*blockHeight + (blockHeight/2);
            
            for (var i=1; i<5; i++) {
                if (blocks[blockMap[startBlock[0]][startBlock[1]]][i]) {
                        player_direction = i;
                        break;
                }
            }

            player = new Ball(player_x, player_y, player_direction);

            drawBlocks();
            player.draw();

            if (isNaN(timer)) {
				timer = setInterval(mainLoop, 15);
			}
        }

        function chgMovable() {
            if (movable == 0) {
                movable = 1;
            } else if (movable == 1) {
                movable = 0;
            }
        }

        function mainLoop() {


            moveAll();
        }

        function moveAll() {
            // Ball位置判定
            // moveBall();
            context.clearRect(0, 0, canvas.width, canvas.height);
            // ブロック再描画
            drawBlocks();
            //  Ball再描画
            player.move();
        }

        function getStartBlock() {
            for (var n=0; n<blockMap.length; n++) {
                for (var m=0; m<blockMap[n].length; m++) {
                    if (blocks[blockMap[n][m]][6] == "start") {
                        startBlock = [n,m];
                        return startBlock;
                    }
                }
            }
        }

        function drawBlocks() {
            for (var n=0; n<blockMap.length; n++) {
                for (var m=0; m<blockMap[n].length; m++) {
                    drawBlock(blockWidth*m, blockHeight*n , blockMap[n][m]);
                }
            }
        }

        function drawBlock(left, top, blockNumber) {

            center_x = left + (blockWidth  / 2);
            center_y = top  + (blockHeight / 2);

            // 四角形の描画
            context.beginPath();
            context.rect(left, top, blockWidth, blockHeight); // (x, y, width, height)
            context.fillStyle = "blue";
            context.fill();
            context.closePath();

            // 黒い点の描画
            if (blocks[blockNumber][5]) { // center
                context.beginPath();
                context.arc(center_x, center_y, 5, 0, 2 * Math.PI);
                context.fillStyle = "black";
                context.fill();
                context.closePath();
            }

            // 黒い線の描画
            context.beginPath();
            if (blocks[blockNumber][1]) { // left
                context.moveTo(center_x, center_y);
                context.lineTo(center_x-(blockWidth/2), center_y);
            }
            if (blocks[blockNumber][2]) { // up
                context.moveTo(center_x, center_y);
                context.lineTo(center_x, center_y-(blockHeight/2));
            }
            if (blocks[blockNumber][3]) { // right
                context.moveTo(center_x, center_y);
                context.lineTo(center_x+(blockWidth/2), center_y);
            }
            if (blocks[blockNumber][4]) { // down
                context.moveTo(center_x, center_y);
                context.lineTo(center_x, center_y+(blockHeight/2));
            }
            context.strokeStyle = "black";
            context.stroke();
            context.closePath();
        }

        function Ball(x, y, direction, speed=2) {
            this.x = x;
            this.y = y;
            this.speed = speed;
            this.direction = direction;

            this.move = function() {
                var loop_flg = false;
                var inBlock;
                var isCenter = false;

                // 自分がどのブロックにいるかチェック
                for (var n=0; n<blockMap.length; n++) {
                   for (var m=0; m<blockMap[n].length; m++) {
                       if ((blockWidth*m <= this.x) && (blockWidth*(m+1) > this.x) && (blockHeight*n <= this.y) && (blockHeight*(n+1) > this.y)) {
                           inBlock = blockMap[n][m];
                           loop_flg = true;
                           break;
                       }
                    }
                    if (loop_flg) {
                        break;
                    }
                }
                // 自分がブロックの中心にいるかチェック
                // 中心にいた場合は進行方向判定を行う
                if ((this.x == ((blockWidth*m) + (blockWidth/2))) && (this.y == ((blockHeight*n) + (blockHeight/2)))) {
                    isCenter = true;
                    this.changeDirection(inBlock);
                }

                // 自分がいるセクションのtrueチェック。いる？
                
                // speed分進む
                if (movable == 1) {
                    if (this.direction == 1) {
                        this.x -= this.speed;
                    } else if (this.direction == 2) {
                        this.y -= this.speed;
                    } else if (this.direction == 3) {
                        this.x += this.speed;
                    } else if (this.direction == 4) {
                        this.y += this.speed;
                    }
                }

                // 再描画する
                this.draw();
            }

            this.changeDirection = function(inBlock) {
                    // leftから来た場合
                    if (this.direction == 3) {
                        if (blocks[inBlock][3]) {
                            this.direction = 3;
                        } else if (blocks[inBlock][2]) {
                            this.direction = 2;
                        } else if (blocks[inBlock][4]) {
                            this.direction = 4;
                        } else {
                            this.direction = 0;
                        }
                    }

                    // upから来た場合
                    if (this.direction == 4) {
                        if (blocks[inBlock][4]) {
                            this.direction = 4;
                        } else if (blocks[inBlock][1]) {
                            this.direction = 1;
                        } else if (blocks[inBlock][3]) {
                            this.direction = 3;
                        } else {
                            this.direction = 0;
                        }
                    }
                    
                    // rightから来た場合
                    if (this.direction == 1) {
                        if (blocks[inBlock][1]) {
                            this.direction = 1;
                        } else if (blocks[inBlock][2]) {
                            this.direction = 2;
                        } else if (blocks[inBlock][4]) {
                            this.direction = 4;
                        } else {
                            this.direction = 0;
                        }
                    }

                    // downから来た場合
                    if (this.direction == 2) {
                        if (blocks[inBlock][4]) {
                            this.direction = 4;
                        } else if (blocks[inBlock][1]) {
                            this.direction = 1;
                        } else if (blocks[inBlock][3]) {
                            this.direction = 3;
                        } else {
                            this.direction = 0;
                        }
                    }
            }

            this.draw = function() {
                // 黄色い円を描画
                context.beginPath();
                context.arc(this.x, this.y, 10, 0, 2 * Math.PI); // (x, y, radius, startAngle, endAngle)
                context.fillStyle = "yellow";
                context.fill();
                context.closePath();
            }
        }
    </script>
</head>
<body onload="init()">
    <canvas id="myCanvas" width="1200" height="800"></canvas>


</body>
</html>
